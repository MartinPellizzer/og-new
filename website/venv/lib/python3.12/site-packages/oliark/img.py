import os
import random

from PIL import Image

def img_resize(img, w=768, h=768):
    start_size = img.size
    end_size = (w, h)
    if start_size[0] / end_size[0] < start_size[1] / end_size[1]:
        ratio = start_size[0] / end_size[0]
        new_end_size = (end_size[0], int(start_size[1] / ratio))
    else:
        ratio = start_size[1] / end_size[1]
        new_end_size = (int(start_size[0] / ratio), end_size[1])
    img = img.resize(new_end_size)
    w_crop = new_end_size[0] - end_size[0]
    h_crop = new_end_size[1] - end_size[1]
    area = (
        w_crop // 2,
        h_crop // 2,
        new_end_size[0] - w_crop // 2,
        new_end_size[1] - h_crop // 2,
    )
    img = img.crop(area)
    return img

def img_resize_save(in_path, out_path, w=768, h=768, quality=70):
    img = Image.open(in_path)
    img = img_resize(img, w, h)
    img.save(out_path, optimize=True, quality=quality)

def gen_img_herb(data, in_path, out_path, web_path, src, alt=''):
    src = src.replace('/', '-')
    alt = src.replace('-', ' ')

    folderpath_in = f'{vault}/images/2x3/herbs/{herb_slug}'
    folderpath_out = f'website/images/herbs'
    filepath_out = f'{folderpath_out}/{src}.jpg'
    filepath_web = f'/images/herbs/{src}.jpg'
    if os.path.exists(folderpath_in):
        if not os.path.exists(filepath_out):
            filename_rnd = random.choice(os.listdir(folderpath_in))
            img_w, img_h = 768, 768
            img = Image.open(f'{folderpath_in}/{filename_rnd}')
            img = util.img_resize(img, w=img_w, h=img_h)
            img.save(filepath_out, optimize=True, quality=70)
    html = f'<p><img src="{filepath_web}" alt="{alt}"></p>'
    return html



#######################
# ;tw utils
#######################
vault_path = f'/home/ubuntu/vault'

def tw_img_gen_web_herb_rnd(herb, regen=False):
    src = f'/images/herbs/{herb["herb_slug"]}.jpg'
    alt = f'{herb["herb_slug"].replace("-", " ")}'
    herb_folder = f'{vault_path}/terrawhisper/images/herbs/2x3/{herb["herb_slug"]}'
    out_path = f'website/images/herbs/{herb["herb_slug"]}.jpg'
    if os.path.exists(herb_folder):
        execute = False
        if not os.path.exists(out_path): execute = True
        if regen: execute = True
        if execute:
            img_rnd = random.choice(os.listdir(herb_folder))
            in_path = f'{herb_folder}/{img_rnd}'
            img_resize_save(in_path, out_path)
    html = f'<p><img src="{src}" alt="{alt}"></p>\n'
    return html

